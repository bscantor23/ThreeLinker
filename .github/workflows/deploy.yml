name: Deploy ThreeLinker

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment'
        required: false
        default: false
        type: boolean

jobs:
  deploy:
    name: Deploy to Server
    runs-on: [three-linker]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Limpiar logs de nginx antes de build
        run: |
          sudo rm -rf nginx/logs/*

      - name: Setup Docker permissions
        run: |
          # Add user to docker group
          sudo usermod -aG docker $USER
          # Change socket permissions
          sudo chmod 666 /var/run/docker.sock
          # Refresh group membership
          newgrp docker
          # Verify Docker access
          docker --version
          
      - name: Create environment file and ensure package-lock.json exists
        run: |
          echo "VITE_SERVER_URL=http://${{ vars.DOMAIN }}" > .env
          echo "PORT=3001" >> .env
          
          # Ensure package-lock.json exists and is valid
          if [ ! -f package-lock.json ]; then
            echo "üì¶ package-lock.json missing, generating..."
            npm install
          fi
          
      - name: Complete system cleanup before deploy
        run: |
          # Stop all containers and remove volumes
          docker-compose down -v --remove-orphans || true
          
          # Aggressive Docker cleanup
          docker system prune -f --volumes --all || true
          
          # Clean npm cache and node_modules
          npm cache clean --force || true
          rm -rf node_modules package-lock.json || true
          
          # Clean build artifacts and logs
          rm -rf dist build logs nginx/cache || true
          
          # Check disk space
          df -h
          docker system df

      - name: Ensure Docker network exists
        run: |
          docker network inspect threelinker-network >/dev/null 2>&1 || docker network create threelinker-network
          
      - name: Build and start services WITHOUT SSL first
        env:
          VITE_SERVER_URL: ${{ vars.DOMAIN }}
        run: |
          docker-compose build --no-cache
          # Start services EXCEPT nginx (we'll start nginx separately without SSL)
          docker-compose up -d redis threelinker-server-1 threelinker-server-2 frontend
          
      - name: Start nginx with existing config (handles SSL conditionally)
        run: |
          # Use the existing nginx.conf which has conditional SSL logic
          # No need to overwrite - the config handles missing certificates gracefully
          docker-compose up -d nginx
          
          # Wait for nginx to be ready
          echo "Waiting for nginx to start..."
          sleep 10
          
          echo "‚úÖ Nginx started with conditional SSL configuration"
          
      - name: Verify domain connectivity
        run: |
          # Verificar conectividad del dominio
          echo "üåê Verificando conectividad del dominio..."
          DOMAIN="threelinker.genodev.com.co"
          
          # Verificar DNS
          echo "üì° Verificando DNS para $DOMAIN..."
          nslookup $DOMAIN || echo "‚ö†Ô∏è  DNS lookup failed"
          
          # Verificar conectividad HTTP
          echo "üîå Verificando conectividad HTTP..."
          curl -v --connect-timeout 10 http://$DOMAIN/.well-known/acme-challenge/test || echo "‚ö†Ô∏è  HTTP connection failed"
          
          # Verificar que nginx responda internamente
          echo "üè† Verificando nginx interno..."
          docker-compose exec nginx curl -f http://localhost/.well-known/acme-challenge/test || echo "‚ö†Ô∏è  Internal nginx check failed"

      - name: Start nginx with HTTP-only config
        run: |
          # Start nginx with HTTP-only config
          docker-compose up -d nginx
          
          # Wait for nginx to be ready
          echo "Waiting for nginx to start..."
          sleep 10
          
          echo "‚úÖ Nginx started with HTTP-only configuration (SSL disabled)"

      - name: Obtener/renovar certificado SSL con Certbot
        env:
          CERTBOT_EMAIL: bscantor3@gmail.com
          DOMAIN: threelinker.genodev.com.co
        run: |
          # Verificar que nginx est√© funcionando antes de solicitar certificados
          echo "üîç Verificando que nginx est√© accesible..."
          timeout 30 bash -c 'until curl -f http://localhost/.well-known/acme-challenge/test 2>/dev/null; do sleep 2; done' || echo "‚ö†Ô∏è  Nginx no est√° completamente listo, continuando..."
          
          # Solicita el certificado usando standalone mode (m√°s confiable)
          echo "üîê Solicitando certificado SSL..."
          docker-compose stop nginx || true
          sleep 5
          docker-compose run --rm --service-ports certbot \
            certonly --standalone \
            --email "$CERTBOT_EMAIL" \
            --agree-tos --no-eff-email \
            -d "$DOMAIN"
          docker-compose start nginx

      - name: Recargar nginx tras certbot
        run: |
          docker-compose exec nginx nginx -s reload || true
          
      - name: SSL Setup Troubleshooting
        if: failure()
        run: |
          echo "üîß Troubleshooting SSL setup..."
          echo "=== Container Status ==="
          docker-compose ps
          echo "=== Nginx Logs ==="
          docker-compose logs nginx --tail=20
          echo "=== Certbot Logs ==="
          docker-compose logs certbot --tail=10 || echo "No certbot logs found"
          echo "=== Network Status ==="
          docker network ls
          docker network inspect threelinker_threelinker-network || echo "Network not found"
          
          echo "üí° SSL setup failed, but deployment can continue without SSL"
          echo "üåê Site will be available on HTTP until SSL is manually configured"
          
      - name: Verify deployment
        run: |
          # Check if containers are running
          docker-compose ps
          
      - name: Post-deploy cleanup
        if: always()
        run: |
          # Clean up after deployment
          docker system prune -f || true
          npm cache clean --force || true
          
          # Show final disk usage
          echo "=== Final Disk Usage ==="
          df -h
          echo "=== Final Docker Usage ==="
          docker system df

      - name: Show service logs
        if: failure()
        run: |
          echo "=== Container Status ==="
          docker-compose ps
          echo "=== Service Logs ==="
          docker-compose logs --tail=50