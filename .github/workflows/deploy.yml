name: Deploy ThreeLinker

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment'
        required: false
        default: false
        type: boolean

jobs:
  deploy:
    name: Deploy to Server
    runs-on: [three-linker]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Limpiar logs de nginx antes de build
        run: |
          sudo rm -rf nginx/logs/* || true

      - name: Setup Docker permissions
        run: |
          # Add user to docker group (en runner self-hosted)
          sudo usermod -aG docker $USER || true
          # Change socket permissions
          sudo chmod 666 /var/run/docker.sock || true
          # Verify Docker access
          docker --version
          
      - name: Create environment file
        run: |
          echo "VITE_SERVER_URL=https://${{ vars.DOMAIN }}" > .env
          # PORT ya no es necesario aqu√≠; se maneja en docker-compose por servicio

      - name: Complete system cleanup before deploy
        run: |
          # Stop all containers and remove volumes
          docker-compose down -v --remove-orphans || true
          
          # Aggressive Docker cleanup
          docker system prune -f --volumes --all || true
          
          # Clean npm cache and node_modules (pero NO borrar package-lock.json)
          npm cache clean --force || true
          rm -rf node_modules || true
          
          # Clean build artifacts and logs
          rm -rf dist build logs nginx/cache || true
          
          # Check disk space
          df -h
          docker system df

      - name: Ensure Docker network exists
        run: |
          docker network inspect threelinker-network >/dev/null 2>&1 || docker network create threelinker-network
          
      - name: Build and start services WITHOUT SSL first
        env:
          VITE_SERVER_URL: https://${{ vars.DOMAIN }}
        run: |
          docker-compose build --no-cache
          # Start core services
          docker-compose up -d redis threelinker-server-1 threelinker-server-2 frontend
          
      - name: Start nginx
        run: |
          docker-compose up -d nginx
          
          echo "Waiting for nginx to start..."
          sleep 10
          
          echo "‚úÖ Nginx started (HTTP y HTTPS configurados)"

      - name: Verify domain connectivity
        run: |
          set -e
          echo 'üåê Verificando conectividad del dominio...'
          DOMAIN="threelinker.genodev.com.co"
          
          echo "üì° Verificando DNS para $DOMAIN..."
          nslookup "$DOMAIN" || echo "‚ö†Ô∏è DNS lookup failed"
          
          echo "üîå Verificando conectividad HTTP..."
          curl -v --connect-timeout 10 "http://$DOMAIN/.well-known/acme-challenge/test" || echo "‚ö†Ô∏è HTTP connection failed (es normal si el archivo no existe)"
          
          echo "üè† Verificando nginx interno..."
          docker-compose exec nginx curl -s -o /dev/null -w "%{http_code}\n" http://localhost/api/health || echo "‚ö†Ô∏è Internal nginx check failed"
