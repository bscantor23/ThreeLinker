# nginx.local.conf - ConfiguraciÃ³n para pruebas locales (HTTP)
# Nginx corre en Docker -> Node corre en Host (host.docker.internal)

# === UPSTREAMS ===

upstream linker_frontend {
    # host.docker.internal permite acceder al localhost del host (Mac) desde el contenedor
    server host.docker.internal:5173 max_fails=3 fail_timeout=30s;
    keepalive 8;
}

upstream linker_backend {
    # Sticky sessions por roomId
    hash $arg_roomId consistent;

    server host.docker.internal:3001 max_fails=3 fail_timeout=30s;
    server host.docker.internal:3002 max_fails=3 fail_timeout=30s;

    keepalive 32;
}

# === MAP PARA WEBSOCKETS ===
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

# Rate limiting (relaxed for local dev)
limit_req_zone $binary_remote_addr zone=api:10m rate=100r/s;
limit_req_zone $binary_remote_addr zone=websocket:10m rate=200r/s;

# === SERVER HTTP (80) ===
server {
    listen 80;
    server_name _;

    # === FRONTEND ===
    location / {
        proxy_pass http://linker_frontend;

        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }

    # === SOCKET.IO ===
    location /socket.io/ {
        proxy_pass http://linker_backend;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        
        proxy_set_header X-Room-ID $arg_roomId;

        # Timeouts extendidos para evitar desconexiones en WebSockets
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }

    # === API ===
    location /api/ {
        proxy_pass http://linker_backend;
        proxy_set_header Host $host;
    }
}
