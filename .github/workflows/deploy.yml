name: Deploy ThreeLinker

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment'
        required: false
        default: false
        type: boolean

jobs:
  deploy:
    name: Deploy to Server
    runs-on: [three-linker]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Limpiar logs de nginx antes de build
        run: |
          sudo rm -rf nginx/logs/*

      - name: Setup Docker permissions
        run: |
          # Add user to docker group
          sudo usermod -aG docker $USER
          # Change socket permissions
          sudo chmod 666 /var/run/docker.sock
          # Refresh group membership
          newgrp docker
          # Verify Docker access
          docker --version
          
      - name: Create environment file
        run: |
          echo "VITE_SERVER_URL=http://${{ vars.DOMAIN }}" > .env
          echo "PORT=3001" >> .env
          
      - name: Stop existing containers
        run: |
          docker-compose down || true
          docker system prune -f || true
          
      - name: Build and start services
        env:
          VITE_SERVER_URL: ${{ vars.DOMAIN }}
        run: |
          docker-compose build --no-cache
          docker-compose up -d
          

      - name: Wait for services to start
        run: |
          echo "Waiting for services to be ready..."
          sleep 5

      - name: Obtener/renovar certificado SSL con Certbot
        env:
          CERTBOT_EMAIL: bscantor3@gmail.com
          DOMAIN: threelinker.genodev.com.co
        run: |
          # Solicita el certificado si no existe, si existe intenta renovar
          if [ ! -d ./nginx/certbot-www ]; then mkdir -p ./nginx/certbot-www; fi
          docker-compose run --rm certbot certonly --webroot --webroot-path=/var/www/certbot --email "$CERTBOT_EMAIL" --agree-tos --no-eff-email -d "$DOMAIN" || \
          docker-compose run --rm certbot renew

      - name: Recargar nginx tras certbot
        run: |
          docker-compose exec nginx nginx -s reload || true
          
      - name: Verify deployment
        run: |
          # Check if containers are running
          docker-compose ps
          
      - name: Show service logs
        if: failure()
        run: |
          echo "=== Container Status ==="
          docker-compose ps
          echo "=== Service Logs ==="
          docker-compose logs --tail=50